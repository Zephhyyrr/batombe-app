version: 2.1

jobs:
  build-and-deploy:
    docker:
      # Menggunakan image terbaru (Android 15 ready)
      - image: cimg/android:2024.10.1

    environment:
      JVM_OPTS: -Xmx4096m

    steps:
      - checkout

      # 1. Decode Kunci
      - run:
          name: Decode Firebase Credentials
          command: echo $FIREBASE_KEY_BASE64 | base64 -d > firebase-key.json

      # 2. Install Firebase CLI
      - run:
          name: Install Firebase CLI
          command: |
            curl -sL https://firebase.tools | bash

      # 3. BUILD DEBUG (PENTING: JANGAN GANTI JADI RELEASE)
      # Kita pakai debug agar otomatis ditandatangani oleh debug keystore bawaan
      - run:
          name: Build Debug APK
          command: |
            chmod +x ./gradlew
            ./gradlew assembleDebug

      # 4. Upload Otomatis (Script Pencari File)
      # Script ini akan mencari file .apk apapun yang dihasilkan langkah 3
      - run:
          name: Upload to Firebase App Distribution
          command: |
            export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/firebase-key.json"
            
            echo "Sedang mencari file APK..."
            
            # Cari file .apk di dalam folder outputs/apk/debug
            # -name "*.apk" artinya cari file apa saja yang belakangnya .apk
            APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
            
            if [ -z "$APK_PATH" ]; then
              echo "GAWAT: File APK tidak ditemukan. Cek langkah build di atas."
              # Tampilkan isi folder untuk debugging
              ls -R app/build/outputs/apk/
              exit 1
            fi
            
            echo "Ditemukan APK di: $APK_PATH"
            
            firebase appdistribution:distribute "$APK_PATH" \
              --app "1:356643992590:android:dbb0357ef10d23d31db85f" \
              --groups "Tester-Batombe" \
              --release-notes "Debug release from CircleCI build #${CIRCLE_BUILD_NUM}"

      # 5. Simpan Artifact
      - store_artifacts:
          path: app/build/outputs/apk/debug/
          destination: apk-debug

workflows:
  version: 2
  release-workflow:
    jobs:
      - build-and-deploy:
          filters:
            branches:
              only: production