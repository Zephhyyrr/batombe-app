version: 2.1

jobs:
  build-and-deploy:
    docker:
      - image: cimg/android:2024.01.1
        # Image ini sudah ada Node.js (dibutuhkan untuk install firebase-tools)

    environment:
      JVM_OPTS: -Xmx3072m

    steps:
      - checkout

      # 1. Decode Kunci JSON (Sama seperti sebelumnya)
      - run:
          name: Decode Firebase Credentials
          command: echo $FIREBASE_KEY_BASE64 | base64 -d > firebase-key.json

      # 2. Install Firebase CLI
      - run:
          name: Install Firebase CLI
          command: |
            curl -sL https://firebase.tools | bash

      # 3. Beri izin & Build APK
      - run:
          name: Build Release APK
          command: |
            chmod +x ./gradlew
            ./gradlew assembleRelease

      # 4. Upload ke Firebase menggunakan CLI (Bukan Gradle)
      # Best Practice: Parameter deployment ada di sini, bukan di source code aplikasi.
      - run:
          name: Upload to Firebase App Distribution
          command: |
            export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/firebase-key.json"
            
            firebase appdistribution:distribute app/build/outputs/apk/debug/app-debug.apk \
              --app "1:356643992590:android:dbb0357ef10d23d31db85f" \
              --groups "Tester-Batombe" \
              --release-notes "New release from CircleCI build #${CIRCLE_BUILD_NUM}"

      - store_artifacts:
          path: app/build/outputs/apk/release/
          destination: apk-release

workflows:
  version: 2
  release-workflow:
    jobs:
      - build-and-deploy:
          filters:
            branches:
              only: production